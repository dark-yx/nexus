{% extends "base.html" %}
{% block title %}Asistente Virtual{% endblock %}
{% block content %}

<br><br>

<div class="chat-container">
    <h1 class="mt-5">Tu asistente de Growth Marketing</h1>
    <p class="lead">
      Este asistente está preparado para responder todas tus preguntas sobre Marketing Digital, Desarrollo de Producto, Growth Hacking, entre otros.
    </p>
    <ul>
      <li>Un proyecto oficial: <a href="https://weblifetech.com/" target="_blank">WEBLIFETECH</a></li>
    </ul>

    <div id="list-group" class="list-group w-auto"></div>
    <div class="input-group mb-3">
    <textarea type="text" class="form-control" id="chat-input" placeholder="Escribe aquí..."></textarea>
        <div class="input-group-append">
          <button id="gpt-button" class="btn btn-primary">Enviar</button>
        </div>
    </div>
</div>

<br>

<!-- Enlace al archivo JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

<script>
$(document).ready(function() {
    console.log("Document is ready");

    function sendMessage() {
        var question = $("#chat-input").val();
        if (question.trim() === "") {
            return; // No enviar mensajes vacíos
        }

        let html_data = `
        <div class="list-group-item list-group-item-action d-flex gap-3 py-3">
            <img src="{{ url_for('static', filename='img/iconochat.png') }}" alt="icon" width="32" height="32" class="rounded-circle flex-shrink-0">
            <div class="d-flex gap-2 w-100 justify-content-between">
                <div>
                    <p class="mb-0 opacity-75">${question}</p>
                </div>
            </div>
        </div>
        `;

        $("#chat-input").val('');
        $("#list-group").append(html_data);

        $.ajax({
            type: "POST",
            url: "/wltchat",
            data: {'prompt': question },
            success: function(data) {
                let gpt_data = `
                <div class="list-group-item list-group-item-action d-flex gap-3 py-3">
                    <img src="https://weblifetech.com/assets/img/logoweblifetech-192x192.png" alt="icon" width="32" height="32" class="rounded-circle flex-shrink-0">
                    <div class="d-flex gap-2 w-100 justify-content-between">
                        <div>
                            <div class="mb-0 opacity-75" id="markdown-content">${data.answer}</div>
                        </div>
                    </div>
                </div>
                `;
                $("#list-group").append(gpt_data);

                // Convert the Markdown content to HTML
                $(".mb-0.opacity-75").each(function() {
                    $(this).html(marked.parse($(this).text()));
                });
            }
        });
    }

    // Add event listener to the send button
    $("#gpt-button").click(function() {
        sendMessage();
    });

    // Add event listener for Enter key press
    $("#chat-input").keypress(function(event) {
        if (event.which === 13) { // Enter key pressed
            event.preventDefault(); // Prevent default form submission
            sendMessage();
        }
    });

    // Event listener for the navbar-toggler
    $('button.navbar-toggler').click(function() {
        $('#navbarNav').toggleClass('show');
    });

    // Ensure clicking outside the navbar closes it
    $(document).click(function(event) {
        var clickover = $(event.target);
        var _opened = $(".navbar-collapse").hasClass("show");
        if (_opened === true && !clickover.hasClass("navbar-toggler") && !clickover.parents('.navbar-collapse').length) {
            $('#navbarNav').removeClass('show');
        }
    });
});
</script>

{% endblock %}
